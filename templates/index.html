{% extends 'base.html' %}

{% block head %}
<title>Bookmark</title>
{% endblock %}

{% block body %}


<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <h1>Book Log</h1>
            </div>
            <div class="col-md-6">
                <form id="searchForm" action="/query/" method="POST" style="float: left;">
                    <input id="query" type="text" name="query" placeholder="Search for a book by title, author, etc.">
                    <input id="submitQuery" type="submit" value="Search">
                </form>
            </div>
            <div class="col-md-3">
            </div>
        </div>
        <div class="row">
            <div class="col-md-6" style="height: 50vh; border: none; overflow: hidden;">
                <div class="listHeaderMenu">
                    <form action="/sort" method="post">
                        Sort by: 
                        <input id="sortTitle" name="sortTitle" value="Title {% if sort == 'titleUp' %}üîº{% elif sort == 'titleDown' %}üîΩ{% endif %}" type="submit">
                        <input id="sortAuthor" name="sortAuthor" value="Author {% if sort == 'authorUp' %}üîº{% elif sort == 'authorDown' %}üîΩ{% endif %}" type="submit">
                        <input id="sortPageCount" name="sortPageCount" value="Page Count {% if sort == 'pagesUp' %}üîº{% elif sort == 'pagesDown' %}üîΩ{% endif %}" type="submit">
                        <input id="sortPubDate" name="sortPubDate" value="Publication Date {% if sort == 'pubUp' %}üîº{% elif sort == 'pubDown' %}üîΩ{% endif %}" type="submit">
                        <input id="sortDateAdded" name="sortDateAdded" value="Date Added {% if sort == 'addedUp' %}üîº{% elif sort == 'addedDown' %}üîΩ{% endif %}" type="submit">
                    </form>

                    <form action="/displayMode" method="post" style="padding-left: 20px;">
                        <input name="switchDisplayMode" value="Toggle Display Mode" type="submit">
                    </form>
                </div>
                {% if showImages %}
                <div id="tableContent" style="height: 40vh; overflow: overlay;">
                    <table class="table-wimg">
                        <tr class="bookRow"></tr>
                        {% for i in range(books|length) %}
                            <tr class="bookRow">
                                <td class="thumbnail">
                                    <img id="thumbnail{{books[i].id}}" class="thumbnail" src="{{ books[i].img_url }}" />
                                </td>
                                <td class="bookListing">
                                    <table>
                                        <tr><td class="title-wimg"><h3>{{ books[i].title }}</h3></td></tr>
                                        <tr><td class="author-wimg"><h6>{{ books[i].author }}</h6></td></tr>
                                        {% if books[i].page_count != "" %}
                                            <tr><td class="pages-wimg">{{ books[i].page_count }} pages</td></tr>
                                        {% endif %}
                                        <tr><td class="publicationDate-wimg">Published {{ books[i].pub_date }}</td></tr>
                                        <tr><td class="dateAdded-wimg">Added {{ books[i].date_added }}</td></tr>
                                    </table>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                {% else %}
                    <table class="table-list">
                        <tr class="listHeader">
                            <th class="titleCol">&nbsp&nbspTitle</th>
                            <th class="spacerCol"></th>
                            <th class="authorCol">Author</th>
                            <th class="pageCol">Pages</th>
                            <th class="pubDateCol">Published</th>
                            <th class="startedCol">Started</th>
                            <th class="finishedCol">Finished</th>
                            <th class="controlCol"></th>
                        </tr>
                    </table>

                    <div id="tableContent" style="height: 40vh; overflow: overlay;">
                    <table class="table-list">
                        

                        {% for i in range(books|length) %}
                            <tr class="bookRow">
                                <td class="title" id="title{{books[i].id}}">{{ books[i].title }}</td>
                                <td class="spacerCol"></td>
                                <td class="author" id="author{{books[i].id}}">{{ books[i].author }}</td>
                                {% if books[i].page_count != "" %}
                                    <td class="pages" id="pages{{books[i].id}}">{{ books[i].page_count }}</td>
                                {% endif %}
                                <td class="publicationDate" id="pubDate{{books[i].id}}">{{ books[i].pub_date }}</td>
                                <td class="dateStarted" id="startDate{{books[i].id}}">{{ books[i].date_started }}</td>
                                {% if books[i].date_finished == None %}
                                    <td class="dateFinished" id="finishDateTD{{books[i].id}}">
                                        <form action="/finish_book/" method="POST" style="float:left;">
                                            <input id="finishedBook{{books[i].id}}" type="hidden" name="finishedBook" value={{books[i].id}}>
                                            <input id="finishDate{{books[i].id}}" type="text" name="finishDate" placeholder="..."  value="" style="width:100%;">
                                        </form>
                                    </td>
                                {% else %}
                                    <td class="dateFinished" id="finishDate{{books[i].id}}">{{ books[i].date_finished }}</td>
                                {% endif %}
                                <td id="bookControls{{books[i].id}}" class="bookControls">
                                    <button id="editBtn{{books[i].id}}" class="editBtn" style="float: left;">‚úé</button>
                                </td>
                                <td id="volumeID{{books[i].id}}" style="display:none;">{{books[i].volume_id}}</td>
                                <td id="img_url{{books[i].id}}" style="display:none;">{{books[i].img_url}}</td>
                            </tr>
                        {% endfor %}
                    </table>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    let title, author, pages, published, startDate, finishDate;

    function restoreListing(id) {
        $("#title"+id).html(title);
        $("#author"+id).html(author);
        $("#pages"+id).html(pages);
        $("#pubDate"+id).html(published);
        $("#startDate"+id).html(startDate);
        if (finishDate == "") {
            finishDate = '<form action="/finish_book/" method="POST" style="float:left;"><input id="finishedBook'+id+'" type="hidden" name="finishedBook" value='+id+'><input id="finishDate'+id+'" type="text" name="finishDate" placeholder="..."  value="" style="width:100%;"></form>';
        }
        $("#finishDateTD"+id).html(finishDate);

        $("#cancelEditBtn"+id).remove();
        $("#saveEditBtn"+id).remove();
        $("#deleteBtn"+id).remove();
        $("#editBtn"+id).show();
    }

    $(".editBtn").click(function() {
        var id = this.id.substring(7);
        if ($("#title"+id).html().includes("<input")) {
            return;
        }
        title = $("#title"+id).text();
        $("#title"+id).html('<input type="text" id="titleEditField'+id+'" value="' + title + '"  style="width:100%;">');
        author = $("#author"+id).text();
        $("#author"+id).html('<input type="text" id="authorEditField'+id+'" value="' + author + '"  style="width:100%;">');
        pages = $("#pages"+id).text();
        $("#pages"+id).html('<input type="text" id="pagesEditField'+id+'" value="' + pages + '"  style="width:100%;">');
        published = $("#pubDate"+id).text();
        $("#pubDate"+id).html('<input type="text" id="publishedEditField'+id+'" value="' + published + '"  style="width:100%;">');
        startDate = $("#startDate"+id).text();
        $("#startDate"+id).html('<input type="text" id="startDateEditField'+id+'" value="' + startDate + '"  style="width:100%;">');
        finishDate = $("#finishDate"+id).val();
        $("#finishDateTD"+id).html('<input type="text" id="finishDateEditField'+id+'" value="' + finishDate + '"  style="width:100%;">');

        $("#editBtn"+id).hide();
        $("#bookControls"+id).append('<button id="cancelEditBtn'+id+'" class="cancelEditBtn" style="float: left;">‚Ü©Ô∏è</button>');
        $("#bookControls"+id).append('<button id="saveEditBtn'+id+'" class="saveEditBtn" style="float: left;">üíæ</button>');
        $("#bookControls"+id).append('<form id="deleteBtn'+id+'" action="/delete/'+id+'" style="float: left;"><input id="deleteBtnSubmit'+id+'" type="submit" value="‚ùå"/></form>');
        $("#cancelEditBtn"+id).click(function() { restoreListing(id); });
        $("#saveEditBtn"+id).click(function() {
            title = $("#titleEditField"+id).val();
            author = $("#authorEditField"+id).val();
            pages = $("#pagesEditField"+id).val();
            published = $("#publishedEditField"+id).val();
            startDate = $("#startDateEditField"+id).val();
            finishDate = $("#finishDateEditField"+id).val();
            var thumbnail = $("#img_url"+id).text();
            var volumeID = $("#volumeID"+id).text();

            $("#deleteBtnSubmit"+id).trigger("click");

            $.ajax({
                type: "POST",
                url: '/edit_listing/',
                data: JSON.stringify({
                    'id':id,
                    'title':title,
                    'author':author,
                    'pages':pages,
                    'published':published,
                    'startDate':startDate,
                    'finishDate':finishDate,
                    'thumbnail':thumbnail,
                    'volumeID':volumeID
                }),
                contentType: "application/json",
                success: function (data) {}
            });


        });
    });
</script>



{% endblock %}